<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Админ-панель</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="container my-4" id="page-content"></div>
<div id="modalContainer"></div>

<script>
const CONFIG = {
    BOT_TOKEN: "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11",
    BACKEND_URL: "https://example.com"
};

// ===================== УТИЛИТЫ =====================
function showNotification(type, title, text) {
    Swal.fire({ icon: type, title, text, timer: 2000, showConfirmButton: false });
}

// ===================== ПРОМОКОДЫ =====================
async function loadPromoCodes() {
    try {
        const codes = JSON.parse(localStorage.getItem('promo_codes') || '[]');
        let activeCount = codes.filter(c => !c.is_used).length;
        let usedCount = codes.filter(c => c.is_used).length;
        let totalAmount = codes.reduce((sum, c) => sum + c.amount, 0);
        
        let tableHtml = '';
        if(codes.length) {
            codes.forEach(code => {
                tableHtml += `
                    <tr>
                        <td>${code.code}</td>
                        <td>$${code.amount.toFixed(2)}</td>
                        <td>${code.is_used ? 'Да' : 'Нет'}</td>
                        <td>${new Date(code.created_at).toLocaleDateString('ru-RU')}</td>
                        <td>${code.expiry_days > 0 ? code.expiry_days + ' дней' : 'Бессрочно'}</td>
                        <td>
                            ${!code.is_used ? `<button class="btn btn-sm btn-danger" onclick="deletePromoCode('${code.code}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            });
        } else {
            tableHtml = `
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="fas fa-gift fa-3x mb-3"></i>
                        <h5>Нет промокодов</h5>
                        Создайте первый промокод
                    </td>
                </tr>
            `;
        }

        $('#codesTableBody').html(tableHtml);
        $('#active-codes-count').text(activeCount);
        $('#used-codes-count').text(usedCount);
        $('#total-codes-amount').text('$' + totalAmount.toFixed(2));
    } catch(err) { console.error(err); }
}

function showGenerateCodesModal() {
    $('#modalContainer').html(`
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-gift me-2"></i>Создать промокоды</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="generateCodesForm">
                        <div class="mb-3">
                            <label class="form-label">Количество кодов</label>
                            <input type="number" class="form-control" id="codeCount" min="1" max="100" value="10" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Сумма ($)</label>
                            <input type="number" class="form-control" id="codeAmount" min="0.01" max="1000" step="0.01" value="10.00" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Префикс (опционально)</label>
                            <input type="text" class="form-control" id="codePrefix" placeholder="PROMO" maxlength="10">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Срок действия (дней)</label>
                            <input type="number" class="form-control" id="codeExpiry" min="0" max="365" value="30">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="generateNewCodes()">Создать</button>
                </div>
            </div>
        </div>
    `).modal('show');
}

function generateNewCodes() {
    const count = parseInt($('#codeCount').val());
    const amount = parseFloat($('#codeAmount').val());
    const prefix = $('#codePrefix').val() || 'PROMO';
    const expiry = parseInt($('#codeExpiry').val());
    
    const existingCodes = JSON.parse(localStorage.getItem('promo_codes') || '[]');
    const codes = [];

    for(let i=0;i<count;i++){
        let code;
        do {
            code = prefix + Math.random().toString(36).substr(2,8).toUpperCase();
        } while(existingCodes.some(c=>c.code===code) || codes.some(c=>c.code===code));

        codes.push({
            code,
            amount,
            is_used:false,
            created_at:new Date().toISOString(),
            expiry_days:expiry,
            used_by:null,
            used_at:null
        });
    }

    localStorage.setItem('promo_codes', JSON.stringify([...existingCodes, ...codes]));

    Swal.fire({
        title:'Промокоды созданы',
        html:`<pre>${codes.map(c=>c.code).join('\n')}</pre>`,
        width:600
    });

    $('#modalContainer').modal('hide');
    loadPromoCodes();
}

function deletePromoCode(code){
    Swal.fire({
        title:'Удалить промокод?',
        text:`Код ${code} будет удален безвозвратно`,
        icon:'warning',
        showCancelButton:true,
        confirmButtonText:'Да, удалить'
    }).then(res=>{
        if(res.isConfirmed){
            const codes = JSON.parse(localStorage.getItem('promo_codes')||'[]');
            const updated = codes.filter(c=>c.code!==code);
            localStorage.setItem('promo_codes', JSON.stringify(updated));
            showNotification('success','Удалено',`Промокод ${code} удален`);
            loadPromoCodes();
        }
    });
}

// ===================== НАСТРОЙКИ СИСТЕМЫ =====================
function loadSettingsContent() {
    const saved = JSON.parse(localStorage.getItem('bot_settings')||'{}');
    $('#page-content').html(`
        <div class="card">
            <div class="card-header bg-white">
                <h5><i class="fas fa-cog me-2"></i>Настройки системы</h5>
            </div>
            <div class="card-body">
                <form id="settingsForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Минимальный вывод ($)</label>
                            <input type="number" class="form-control" id="minWithdrawal" value="${saved.minWithdrawal||50}">
                        </div>
                        <div class="col-md-6">
                            <label>Реферальный бонус ($)</label>
                            <input type="number" class="form-control" id="referralBonus" value="${saved.referralBonus||10}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Ежедневный бонус ($)</label>
                            <input type="number" class="form-control" id="dailyBonus" value="${saved.dailyBonus||2}">
                        </div>
                        <div class="col-md-6">
                            <label>Таймаут сессии (мин)</label>
                            <input type="number" class="form-control" id="sessionTimeout" value="${saved.sessionTimeout||60}">
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="notifyNewUsers" ${saved.notifyNewUsers?'checked':''}>
                        <label class="form-check-label">Уведомлять о новых пользователях</label>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить</button>
                </form>
            </div>
        </div>
    `);
}

function saveSettings() {
    const settings = {
        minWithdrawal: $('#minWithdrawal').val(),
        referralBonus: $('#referralBonus').val(),
        dailyBonus: $('#dailyBonus').val(),
        sessionTimeout: $('#sessionTimeout').val(),
        notifyNewUsers: $('#notifyNewUsers').is(':checked')
    };
    localStorage.setItem('bot_settings', JSON.stringify(settings));
    showNotification('success','Сохранено','Настройки сохранены');
}

// ===================== СТАТУС СИСТЕМЫ =====================
async function checkSystemStatus() {
    try {
        const [bot, backend, db] = await Promise.all([
            fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/getMe`).then(r=>r.json()).catch(()=>({ok:false})),
            fetch(CONFIG.BACKEND_URL).then(r=>r.json()).catch(()=>({status:'error'})),
            fetch(`${CONFIG.BACKEND_URL}/api/stats`).then(r=>r.json()).catch(()=>({status:'error'}))
        ]);
        console.log('Статус:', {bot, backend, db});
    } catch(e){ console.error(e); }
}

// ===================== ИНИЦИАЛИЗАЦИЯ =====================
$(document).ready(()=>{
    loadPromoCodes();
    loadSettingsContent();
});
</script>
</body>
</html>
