<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Панель администратора</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; }
.navbar-brand { font-weight: bold; }
.card { margin-bottom: 1.5rem; }
.table-hover tbody tr:hover { background-color: #f1f1f1; }
.modal-dialog { max-width: 800px; }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
<div class="container-fluid">
<a class="navbar-brand" href="#">Admin Panel</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link active" href="#" onclick="loadDashboard()">Главная</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadUsers()">Пользователи</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadPromoCodes()">Промокоды</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadTransactionsContent()">Транзакции</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadSettingsContent()">Настройки</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadApiContent()">API</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="showBroadcastModal()">Рассылка</a></li>
</ul>
</div>
</div>
</nav>

<div class="container" id="page-content"></div>

<div id="modalContainer"></div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
const CONFIG = {
    BACKEND_URL: 'https://yourbackend.example.com',
    BOT_TOKEN: '8402586959:AAGRTEGtSy7KoUlJDZvaNSxL3JKuZPWUMrY'
};

// ===================== Уведомления =====================
function showNotification(type, title, message) {
    Swal.fire({ icon: type, title: title, text: message, timer: 2000, showConfirmButton: false });
}

// ===================== Дашборд =====================
function loadDashboard() {
    $('#page-content').html(`
        <div class="row">
            <div class="col-md-4"><div class="card text-white bg-primary"><div class="card-body">
                <h5 class="card-title"><i class="fas fa-users"></i> Пользователи</h5>
                <p class="card-text" id="dashboardUsers">Загрузка...</p>
            </div></div></div>
            <div class="col-md-4"><div class="card text-white bg-success"><div class="card-body">
                <h5 class="card-title"><i class="fas fa-coins"></i> Баланс</h5>
                <p class="card-text" id="dashboardBalance">Загрузка...</p>
            </div></div></div>
            <div class="col-md-4"><div class="card text-white bg-warning"><div class="card-body">
                <h5 class="card-title"><i class="fas fa-gift"></i> Промокоды</h5>
                <p class="card-text" id="dashboardPromo">Загрузка...</p>
            </div></div></div>
        </div>
    `);
    $.get(`${CONFIG.BACKEND_URL}/api/stats`).done(res=>{
        $('#dashboardUsers').text(res.users);
        $('#dashboardBalance').text('$'+res.total_balance);
        $('#dashboardPromo').text(res.promo);
    }).fail(()=>{showNotification('error','Ошибка','Не удалось загрузить данные')});
}

// ===================== Пользователи =====================
async function loadUsers() {
    $('#page-content').html(`<div class="card"><div class="card-header">Пользователи</div>
    <div class="card-body"><table class="table table-hover"><thead>
    <tr><th>ID</th><th>Имя</th><th>Username</th><th>Баланс</th><th>Действия</th></tr></thead>
    <tbody id="usersTableBody"><tr><td colspan="5" class="text-center">Загрузка...</td></tr></tbody>
    </table></div></div>`);

    try {
        const users = await fetch(`${CONFIG.BACKEND_URL}/api/users`,{headers:{'X-Auth-Token':'admin'}}).then(r=>r.json());
        let html='';
        users.forEach(u=>{html+=`<tr>
            <td>${u.id}</td>
            <td>${u.first_name}</td>
            <td>${u.username}</td>
            <td>$${u.balance}</td>
            <td>
                <button class="btn btn-sm btn-success" onclick="addBalance(${u.id})"><i class="fas fa-plus"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
            </td></tr>`});
        $('#usersTableBody').html(html);
    } catch {$('#usersTableBody').html('<tr><td colspan="5" class="text-center text-danger">Ошибка загрузки</td></tr>');}
}

function addBalance(userId){
    Swal.fire({title:'Начислить баланс', input:'number', inputLabel:'Сумма', showCancelButton:true}).then(res=>{
        if(res.value){fetch(`${CONFIG.BACKEND_URL}/api/user/add_balance`,{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':'admin'},body:JSON.stringify({user_id:userId,amount:res.value})}).then(()=>{showNotification('success','Успех','Баланс обновлён');loadUsers();});}
    });
}

function deleteUser(userId){
    Swal.fire({title:'Удалить пользователя?',icon:'warning',showCancelButton:true}).then(res=>{
        if(res.isConfirmed){fetch(`${CONFIG.BACKEND_URL}/api/user/delete`,{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':'admin'},body:JSON.stringify({user_id:userId})}).then(()=>{showNotification('success','Удалено','Пользователь удалён');loadUsers();});}
    });
}

// ===================== Промокоды =====================
async function loadPromoCodes(){
    $('#page-content').html(`<div class="card"><div class="card-header">Промокоды <button class="btn btn-sm btn-primary float-end" onclick="showGenerateCodesModal()">Создать</button></div>
    <div class="card-body"><table class="table table-hover"><thead>
    <tr><th>Код</th><th>Сумма</th><th>Статус</th><th>Действия</th></tr></thead>
    <tbody id="codesTableBody"><tr><td colspan="4" class="text-center">Загрузка...</td></tr></tbody></table></div></div>`);
    try {
        const codes=await fetch(`${CONFIG.BACKEND_URL}/api/promo`,{headers:{'X-Auth-Token':'admin'}}).then(r=>r.json());
        let html='';
        codes.forEach(c=>{html+=`<tr>
            <td>${c.code}</td>
            <td>$${c.amount}</td>
            <td>${c.is_used?'Использован':'Активен'}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deletePromo('${c.code}')"><i class="fas fa-trash"></i></button></td>
        </tr>`});
        $('#codesTableBody').html(html);
    } catch{$('#codesTableBody').html('<tr><td colspan="4" class="text-center text-danger">Ошибка загрузки</td></tr>');}
}

function showGenerateCodesModal(){
    $('#modalContainer').html(`<div class="modal-dialog"><div class="modal-content"><div class="modal-header">
    <h5 class="modal-title">Создать промокоды</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
    <input type="number" id="promoCount" class="form-control mb-2" placeholder="Количество"><input type="number" id="promoAmount" class="form-control" placeholder="Сумма">
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
    <button class="btn btn-primary" onclick="generatePromo()">Создать</button></div></div></div>`).modal('show');
}

function generatePromo(){
    const count=$('#promoCount').val(); const amount=$('#promoAmount').val();
    fetch(`${CONFIG.BACKEND_URL}/api/promo/create`,{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':'admin'},body:JSON.stringify({count,amount})}).then(()=>{showNotification('success','Создано','Промокоды созданы');$('#modalContainer').modal('hide');loadPromoCodes();});
}

function deletePromo(code){
    Swal.fire({title:'Удалить промокод?',icon:'warning',showCancelButton:true}).then(res=>{if(res.isConfirmed){fetch(`${CONFIG.BACKEND_URL}/api/promo/delete`,{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':'admin'},body:JSON.stringify({code})}).then(()=>{showNotification('success','Удалено','Промокод удалён');loadPromoCodes();});}});
}

// ===================== Транзакции =====================
async function loadTransactionsContent(){
    $('#page-content').html(`<div class="card"><div class="card-header">История транзакций</div><div class="card-body">
    <table class="table table-hover"><thead><tr><th>ID</th><th>Пользователь</th><th>Тип</th><th>Сумма</th><th>Дата</th></tr></thead>
    <tbody id="transactionsTableBody"><tr><td colspan="5" class="text-center">Загрузка...</td></tr></tbody></table></div></div>`);
    try{const trans=await fetch(`${CONFIG.BACKEND_URL}/api/transactions`,{headers:{'X-Auth-Token':'admin'}}).then(r=>r.json());
        let html=''; trans.forEach(t=>{html+=`<tr><td>${t.id}</td><td>${t.user_name}</td><td>${t.type}</td><td>$${t.amount}</td><td>${t.date}</td></tr>`});
        $('#transactionsTableBody').html(html);
    }catch{$('#transactionsTableBody').html('<tr><td colspan="5" class="text-center text-danger">Ошибка загрузки</td></tr>');}
}

// ===================== Настройки =====================
function loadSettingsContent(){
    $('#page-content').html(`<div class="card"><div class="card-header">Настройки</div><div class="card-body">
    <div class="mb-3"><label>Telegram Bot Token</label><input type="text" class="form-control" id="botToken" value="${CONFIG.BOT_TOKEN}"></div>
    <div class="mb-3"><label>Backend URL</label><input type="text" class="form-control" id="backendUrl" value="${CONFIG.BACKEND_URL}"></div>
    <button class="btn btn-primary" onclick="saveSettings()">Сохранить</button></div></div>`);}
function saveSettings(){CONFIG.BOT_TOKEN=$('#botToken').val();CONFIG.BACKEND_URL=$('#backendUrl').val();showNotification('success','Сохранено','Настройки обновлены');}

// ===================== API документация =====================
function loadApiContent(){
    $('#page-content').html(`<div class="card"><div class="card-header">API Документация</div><div class="card-body"><pre>
GET /api/users
POST /api/user/add
POST /api/user/delete
POST /api/user/add_balance
GET /api/promo
POST /api/promo/create
POST /api/promo/delete
GET /api/transactions
POST /api/bot/send
    </pre></div></div>`);}

// ===================== Массовая рассылка =====================
function showBroadcastModal(){
    $('#modalContainer').html(`<div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Рассылка</h5>
    <button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <textarea class="form-control" id="broadcastText" placeholder="Текст сообщения"></textarea></div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
    <button class="btn btn-primary" onclick="sendBroadcast()">Отправить</button></div></div></div>`).modal('show');}

function sendBroadcast(){const text=$('#broadcastText').val();if(!text){showNotification('error','Ошибка','Введите текст');return;}
fetch(`${CONFIG.BACKEND_URL}/api/bot/send`,{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':'admin'},body:JSON.stringify({text})}).then(()=>{showNotification('success','Отправлено','Рассылка отправлена');$('#modalContainer').modal('hide');});}

// ===================== Инициализация =====================
loadDashboard();
</script>
</body>
</html>
