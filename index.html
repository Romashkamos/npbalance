<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Админ-панель</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.27/dist/sweetalert2.all.min.js"></script>
<style>
body { background: #f8f9fa; }
.navbar-brand { font-weight: bold; }
.table-hover tbody tr:hover { background-color: #e9ecef; }
pre { white-space: pre-wrap; word-wrap: break-word; }
.badge { font-size: 0.9em; }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
<div class="container-fluid">
<a class="navbar-brand" href="#">Admin Panel</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item"><a class="nav-link active" href="#" onclick="loadUsersContent()">Пользователи</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadPromoCodesContent()">Промокоды</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadTransactionsContent()">Транзакции</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadSettingsContent()">Настройки</a></li>
<li class="nav-item"><a class="nav-link" href="#" onclick="loadApiContent()">API</a></li>
</ul>
<button class="btn btn-outline-light" onclick="showBroadcastModal()"><i class="fas fa-bullhorn"></i> Рассылка</button>
</div>
</div>
</nav>

<div class="container-fluid my-4" id="page-content"></div>

<div id="modalContainer"></div>

<script>
const CONFIG = {
BOT_TOKEN: '8402586959:AAGRTEGtSy7KoUlJDZvaNSxL3JKuZPWUMrY',
BACKEND_URL: 'https://your-backend.example.com'
};

// ===================== УВЕДОМЛЕНИЯ =====================
function showNotification(type, title, text) {
Swal.fire({ icon: type, title: title, text: text, timer: 2000, showConfirmButton: false });
}

// ===================== ПОЛЬЗОВАТЕЛИ =====================
async function loadUsersContent() {
$('#page-content').html(`<div class="card">
<div class="card-header bg-white"><h5><i class="fas fa-users me-2"></i>Пользователи</h5></div>
<div class="card-body">
<div class="mb-3"><button class="btn btn-primary" onclick="showAddUserModal()"><i class="fas fa-user-plus me-1"></i> Добавить пользователя</button></div>
<div class="table-responsive"><table class="table table-hover" id="usersTable">
<thead><tr><th>ID</th><th>Telegram</th><th>Имя</th><th>Баланс</th><th>Действия</th></tr></thead>
<tbody id="usersTableBody"><tr><td colspan="5" class="text-center py-5"><div class="spinner-border spinner-border-sm"></div> Загрузка...</td></tr></tbody>
</table></div></div></div>`);
loadUsers();
}

function loadUsers() {
let users = JSON.parse(localStorage.getItem('users') || '[]');
let html = '';
if(users.length>0){users.forEach(u=>{
html+=`<tr>
<td>${u.id}</td>
<td>${u.username}</td>
<td>${u.first_name}</td>
<td>$${u.balance.toFixed(2)}</td>
<td>
<button class="btn btn-sm btn-success me-1" onclick="addBalance(${u.id})"><i class="fas fa-plus"></i></button>
<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
</td></tr>`;
});} else {html=`<tr><td colspan="5" class="text-center py-5"><i class="fas fa-user-slash fa-3x text-muted mb-3"></i><h5>Нет пользователей</h5></td></tr>`;}
$('#usersTableBody').html(html);
}

function showAddUserModal() {
$('#modalContainer').html(`<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Добавить пользователя</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<form id="addUserForm">
<div class="mb-3"><label class="form-label">Telegram ID</label><input type="number" class="form-control" id="newUserId" required></div>
<div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control" id="newUsername" required></div>
<div class="mb-3"><label class="form-label">Имя</label><input type="text" class="form-control" id="newFirstName" required></div>
<div class="mb-3"><label class="form-label">Баланс ($)</label><input type="number" class="form-control" id="newBalance" value="0" min="0" required></div>
</form></div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
<button class="btn btn-primary" onclick="addUser()">Добавить</button>
</div></div></div>`).modal('show');
}

function addUser() {
let users = JSON.parse(localStorage.getItem('users') || '[]');
let id=parseInt($('#newUserId').val());
if(users.find(u=>u.id===id)){showNotification('error','Ошибка','Пользователь уже существует');return;}
users.push({id:id,username:$('#newUsername').val(),first_name:$('#newFirstName').val(),balance:parseFloat($('#newBalance').val())});
localStorage.setItem('users',JSON.stringify(users));
$('#modalContainer').modal('hide');
showNotification('success','Успех','Пользователь добавлен');
loadUsers();
}

function addBalance(id){
Swal.fire({title:'Начислить баланс',input:'number',inputLabel:'Сумма ($)',inputValue:0,showCancelButton:true}).then(r=>{
if(r.isConfirmed){let users=JSON.parse(localStorage.getItem('users')||'[]');let u=users.find(u=>u.id===id);if(u){u.balance+=parseFloat(r.value);localStorage.setItem('users',JSON.stringify(users));showNotification('success','Успех','Баланс обновлен');loadUsers();}}});
}

function deleteUser(id){
Swal.fire({title:'Удалить пользователя?',text:'Данные будут потеряны',icon:'warning',showCancelButton:true,confirmButtonText:'Удалить'}).then(r=>{
if(r.isConfirmed){let users=JSON.parse(localStorage.getItem('users')||'[]');users=users.filter(u=>u.id!==id);localStorage.setItem('users',JSON.stringify(users));showNotification('success','Удалено','Пользователь удален');loadUsers();}})}

// ===================== ПРОМОКОДЫ =====================
function loadPromoCodesContent(){
$('#page-content').html(`<div class="card"><div class="card-header bg-white"><h5><i class="fas fa-gift me-2"></i>Промокоды</h5></div>
<div class="card-body"><div class="mb-3"><button class="btn btn-primary" onclick="showGenerateCodesModal()"><i class="fas fa-plus me-1"></i> Создать промокод</button></div>
<div class="table-responsive"><table class="table table-hover" id="codesTable"><thead><tr><th>Код</th><th>Сумма</th><th>Использован</th><th>Создан</th><th>Действия</th></tr></thead><tbody id="codesTableBody"><tr><td colspan="5" class="text-center py-5"><div class="spinner-border spinner-border-sm"></div> Загрузка...</td></tr></tbody></table></div></div></div>`);
loadPromoCodes();
}

function loadPromoCodes(){
let codes=JSON.parse(localStorage.getItem('promo_codes')||'[]');let html='';if(codes.length>0){codes.forEach(c=>{
html+=`<tr><td>${c.code}</td><td>$${c.amount}</td><td>${c.is_used?'Да':'Нет'}</td><td>${c.created_at}</td><td>${!c.is_used?`<button class="btn btn-sm btn-danger" onclick="deletePromoCode('${c.code}')"><i class="fas fa-trash"></i></button>`:''}</td></tr>`;
});}else{html=`<tr><td colspan="5" class="text-center py-5"><i class="fas fa-gift fa-3x text-muted mb-3"></i><h5>Нет промокодов</h5></td></tr>`;}
$('#codesTableBody').html(html);
}

function showGenerateCodesModal(){
$('#modalContainer').html(`<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title"><i class="fas fa-gift me-2"></i>Создать промокоды</h5>
<button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<form id="generateCodesForm">
<div class="mb-3"><label>Количество кодов</label><input type="number" class="form-control" id="codeCount" min="1" max="100" value="10" required></div>
<div class="mb-3"><label>Сумма каждого кода ($)</label><input type="number" class="form-control" id="codeAmount" min="0.01" max="1000" step="0.01" value="10.00" required></div>
<div class="mb-3"><label>Префикс кода</label><input type="text" class="form-control" id="codePrefix" placeholder="PROMO" maxlength="10"></div>
<div class="mb-3"><label>Срок действия (дней)</label><input type="number" class="form-control" id="codeExpiry" min="0" max="365" value="30"></div>
</form></div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
<button class="btn btn-primary" onclick="generateNewCodes()">Создать коды</button></div></div></div>`).modal('show');
}

function generateNewCodes(){
const count=parseInt($('#codeCount').val());
const amount=parseFloat($('#codeAmount').val());
const prefix=$('#codePrefix').val()||'PROMO';
const expiry=parseInt($('#codeExpiry').val());
const codes=[];const now=new Date().toLocaleDateString('ru-RU');
for(let i=0;i<count;i++){const random=Math.random().toString(36).substr(2,8).toUpperCase();const code=prefix+random;
codes.push({code:code,amount:amount,is_used:false,created_at:now,expiry_days:expiry,used_by:null,used_at:null});}
const existing=JSON.parse(localStorage.getItem('promo_codes')||'[]');existing.push(...codes);localStorage.setItem('promo_codes',JSON.stringify(existing));
const codesText=codes.map(c=>c.code).join('\n');
Swal.fire({title:'Созданные промокоды',html:`<div class="text-start"><p><strong>Сумма:</strong> $${amount}</p><p><strong>Количество:</strong> ${count}</p><p><strong>Срок:</strong> ${expiry} дней</p><hr><pre class="bg-light p-3 rounded">${codesText}</pre></div>`,confirmButtonText:'Закрыть',width:600});
$('#modalContainer').modal('hide');loadPromoCodes();
}

function deletePromoCode(code){
Swal.fire({title:'Удалить промокод?',text:`Код ${code} будет удален`,icon:'warning',showCancelButton:true,confirmButtonText:'Да, удалить'}).then(r=>{
if(r.isConfirmed){let codes=JSON.parse(localStorage.getItem('promo_codes')||'[]');codes=codes.filter(c=>c.code!==code);localStorage.setItem('promo_codes',JSON.stringify(codes));showNotification('success','Успех!',`Промокод ${code} удален`);loadPromoCodes();}})}

// ===================== ТЕЛЕГРАМ-БОТ =====================
async function sendMessageToUser(chat_id,text){
try{const res=await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id,text,parse_mode:'HTML'})});const data=await res.json();return data.ok}catch(e){console.error(e);return false;}
}

// ===================== МАССОВАЯ РАССЫЛКА =====================
function showBroadcastModal(){
$('#modalContainer').html(`<div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-bullhorn me-2"></i>Массовая рассылка</h5>
<button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
<form id="broadcastForm">
<div class="mb-3"><label>Выберите получателей</label><select class="form-select" id="broadcastTarget" multiple><option value="all" selected>Все пользователи</option></select></div>
<div class="mb-3"><label>Текст сообщения</label><textarea class="form-control" id="broadcastText" rows="6" required></textarea></div>
<div class="mb-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="broadcastPreview" checked><label class="form-check-label" for="broadcastPreview">Показать предварительный просмотр</label></div></div>
</form>
<div class="alert alert-info">Будет отправлено: <span id="broadcastCount">0</span> пользователям</div></div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
<button class="btn btn-primary" onclick="sendBroadcast()">Отправить</button></div></div></div>`).modal('show');
updateBroadcastCount();
}

function updateBroadcastCount(){
let users=JSON.parse(localStorage.getItem('users')||'[]');$('#broadcastCount').text(users.length);
}

async function sendBroadcast(){
const text=$('#broadcastText').val();
if(!text){showNotification('error','Ошибка','Введите текст');return;}
let users=JSON.parse(localStorage.getItem('users')||'[]');
for(let u of users){await sendMessageToUser(u.id,text);}
showNotification('success','Успех','Рассылка отправлена');$('#modalContainer').modal('hide');
}

// ===================== НАСТРОЙКИ =====================
function loadSettingsContent(){
$('#page-content').html(`<div class="card"><div class="card-header bg-white"><h5><i class="fas fa-cog me-2"></i>Настройки системы</h5></div>
<div class="card-body"><form id="settingsForm">
<div class="mb-3"><label>Минимальный вывод ($)</label><input type="number" class="form-control" id="minWithdrawal" value="50"></div>
<div class="mb-3"><label>Реферальный бонус ($)</label><input type="number" class="form-control" id="referralBonus" value="10"></div>
<div class="mb-3"><label>Ежедневный бонус ($)</label><input type="number" class="form-control" id="dailyBonus" value="2"></div>
<div class="mb-3"><label>Таймаут сессии (мин)</label><input type="number" class="form-control" id="sessionTimeout" value="60"></div>
<div class="mb-3"><label>Ваш Telegram ID</label><input type="number" class="form-control" id="adminTelegramId"></div>
<div class="d-flex justify-content-between"><button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить</button></div>
</form></div></div>`);

}

function saveSettings(){
const settings={
minWithdrawal:$('#minWithdrawal').val(),
referralBonus:$('#referralBonus').val(),
dailyBonus:$('#dailyBonus').val(),
sessionTimeout:$('#sessionTimeout').val(),
adminTelegramId:$('#adminTelegramId').val()
};
localStorage.setItem('bot_settings',JSON.stringify(settings));showNotification('success','Сохранено','Настройки сохранены');
}

// ===================== API =====================
function loadApiContent(){
$('#page-content').html(`<div class="card"><div class="card-header bg-white"><h5><i class="fas fa-code me-2"></i>API документация</h5></div>
<div class="card-body"><p>Базовый URL: <code>${CONFIG.BACKEND_URL}/api/</code></p></div></div>`);
}

// ===================== ИНИЦИАЛИЗАЦИЯ =====================
$(document).ready(()=>{loadUsersContent();});
</script>
</body>
</html>
