<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8f9fa; }
        .sidebar { width: 250px; height: 100vh; position: fixed; background: #343a40; color: white; }
        .sidebar a { color: white; text-decoration: none; display: block; padding: 10px 20px; }
        .sidebar a:hover { background: #495057; }
        .content { margin-left: 250px; padding: 20px; }
        pre { font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="sidebar d-flex flex-column">
    <h4 class="text-center py-3 border-bottom">Админ-панель</h4>
    <a href="#" onclick="loadDashboardContent()">Главная</a>
    <a href="#" onclick="loadUsersContent()">Пользователи</a>
    <a href="#" onclick="loadPromoCodesContent()">Промокоды</a>
    <a href="#" onclick="loadTransactionsContent()">Транзакции</a>
    <a href="#" onclick="loadSettingsContent()">Настройки</a>
    <a href="#" onclick="loadApiContent()">API</a>
    <a href="#" onclick="showBroadcastModal()">Массовая рассылка</a>
</div>

<div class="content" id="page-content">
    <!-- Здесь будет контент -->
</div>

<!-- Модальные окна -->
<div id="modalContainer"></div>

<script>
const CONFIG = {
    BOT_TOKEN: "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11",
    BACKEND_URL: "https://example.com"
};

document.addEventListener("DOMContentLoaded", () => loadDashboardContent());

// ===================== УВЕДОМЛЕНИЯ =====================
function showNotification(type, title, text) {
    Swal.fire({ icon: type, title: title, text: text, timer: 2000, toast: true, position: 'top-end', showConfirmButton: false });
}

// ===================== ДЕЙСТВИЯ =====================
function loadDashboardContent() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const codes = JSON.parse(localStorage.getItem('promo_codes') || '[]');
    const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

    const totalUsers = users.length;
    const totalCodes = codes.length;
    const totalTransactions = transactions.length;

    $('#page-content').html(`
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5>Пользователи</h5>
                        <h2>${totalUsers}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5>Промокоды</h5>
                        <h2>${totalCodes}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5>Транзакции</h5>
                        <h2>${totalTransactions}</h2>
                    </div>
                </div>
            </div>
        </div>
    `);
}

// ===================== ПОЛЬЗОВАТЕЛИ =====================
function loadUsersContent() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    let tableHtml = '';
    if (users.length) {
        users.forEach(u => {
            tableHtml += `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.first_name} (${u.username})</td>
                    <td>$${u.balance}</td>
                    <td>${u.created_at}</td>
                </tr>
            `;
        });
    } else {
        tableHtml = `<tr><td colspan="4" class="text-center py-5">Нет пользователей</td></tr>`;
    }

    $('#page-content').html(`
        <div class="card">
            <div class="card-header bg-white">
                <h5>Пользователи</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" onclick="showAddUserModal()">Добавить пользователя</button>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr><th>ID</th><th>Имя (Username)</th><th>Баланс</th><th>Дата регистрации</th></tr>
                        </thead>
                        <tbody>${tableHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `);
}

function showAddUserModal() {
    $('#modalContainer').html(`
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Добавить пользователя</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3"><label>Telegram ID</label><input type="number" id="userTelegramId" class="form-control" required></div>
                        <div class="mb-3"><label>Имя</label><input type="text" id="userFirstName" class="form-control" required></div>
                        <div class="mb-3"><label>Username</label><input type="text" id="userUsername" class="form-control"></div>
                        <div class="mb-3"><label>Баланс ($)</label><input type="number" id="userBalance" class="form-control" value="0"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button class="btn btn-primary" onclick="addUser()">Добавить</button>
                </div>
            </div>
        </div>
    `).modal('show');
}

function addUser() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const id = users.length ? users[users.length - 1].id + 1 : 1;
    const user = {
        id: id,
        telegram_id: parseInt($('#userTelegramId').val()),
        first_name: $('#userFirstName').val(),
        username: $('#userUsername').val(),
        balance: parseFloat($('#userBalance').val()),
        created_at: new Date().toLocaleDateString('ru-RU')
    };
    users.push(user);
    localStorage.setItem('users', JSON.stringify(users));
    $('#modalContainer').modal('hide');
    showNotification('success','Успех','Пользователь добавлен');
    loadUsersContent();
}

// ===================== ПРОМОКОДЫ =====================
function loadPromoCodesContent() {
    const codes = JSON.parse(localStorage.getItem('promo_codes') || '[]');
    let tableHtml = '';
    if (codes.length) {
        codes.forEach(c => {
            tableHtml += `
                <tr>
                    <td>${c.code}</td>
                    <td>$${c.amount}</td>
                    <td>${c.is_used ? 'Да' : 'Нет'}</td>
                    <td>${c.created_at}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deletePromoCode('${c.code}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
        });
    } else {
        tableHtml = `<tr><td colspan="5" class="text-center py-5">Нет промокодов</td></tr>`;
    }

    $('#page-content').html(`
        <div class="card">
            <div class="card-header bg-white"><h5>Промокоды</h5></div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" onclick="showGenerateCodesModal()">Создать промокоды</button>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>Код</th><th>Сумма</th><th>Использован</th><th>Создан</th><th>Действия</th></tr></thead>
                        <tbody>${tableHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `);
}

function showGenerateCodesModal() {
    $('#modalContainer').html(`
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Создать промокоды</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="generateCodesForm">
                        <div class="mb-3"><label>Количество кодов</label><input type="number" class="form-control" id="codeCount" min="1" max="100" value="10"></div>
                        <div class="mb-3"><label>Сумма ($)</label><input type="number" class="form-control" id="codeAmount" min="0.01" max="1000" value="10.00" step="0.01"></div>
                        <div class="mb-3"><label>Префикс</label><input type="text" class="form-control" id="codePrefix" placeholder="PROMO"></div>
                        <div class="mb-3"><label>Срок действия (дней)</label><input type="number" class="form-control" id="codeExpiry" value="30" min="0" max="365"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button class="btn btn-primary" onclick="generateNewCodes()">Создать</button>
                </div>
            </div>
        </div>
    `).modal('show');
}

function generateNewCodes() {
    const count = parseInt($('#codeCount').val());
    const amount = parseFloat($('#codeAmount').val());
    const prefix = $('#codePrefix').val() || 'PROMO';
    const expiry = parseInt($('#codeExpiry').val());
    const codes = JSON.parse(localStorage.getItem('promo_codes') || '[]');

    for (let i=0;i<count;i++){
        const codeStr = prefix + Math.random().toString(36).substr(2,8).toUpperCase();
        codes.push({code: codeStr, amount, is_used:false, created_at:new Date().toLocaleDateString('ru-RU'), expiry_days:expiry});
    }
    localStorage.setItem('promo_codes', JSON.stringify(codes));
    $('#modalContainer').modal('hide');
    showNotification('success','Готово','Промокоды созданы');
    loadPromoCodesContent();
}

function deletePromoCode(code) {
    Swal.fire({title:'Удалить?', text:`Код ${code} будет удален`, icon:'warning', showCancelButton:true, confirmButtonText:'Да'}).then(res=>{
        if(res.isConfirmed){
            let codes = JSON.parse(localStorage.getItem('promo_codes')||'[]');
            codes = codes.filter(c=>c.code!==code);
            localStorage.setItem('promo_codes', JSON.stringify(codes));
            showNotification('success','Удалено',`Промокод ${code} удален`);
            loadPromoCodesContent();
        }
    });
}

// ===================== ТРАНЗАКЦИИ =====================
function loadTransactionsContent() {
    const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
    let tableHtml = '';
    if (transactions.length) {
        transactions.forEach(t=>{
            const amountClass = t.amount>0?'text-success':'text-danger';
            tableHtml += `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.user_name||t.user_id}</td>
                    <td>${t.type}</td>
                    <td class="${amountClass}">${t.amount>0?'+':''}$${t.amount}</td>
                    <td>${t.date}</td>
                    <td>${t.description}</td>
                </tr>
            `;
        });
    } else { tableHtml = `<tr><td colspan="6" class="text-center py-5">Нет транзакций</td></tr>`; }

    $('#page-content').html(`
        <div class="card">
            <div class="card-header bg-white"><h5>Транзакции</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>ID</th><th>Пользователь</th><th>Тип</th><th>Сумма</th><th>Дата</th><th>Описание</th></tr></thead>
                        <tbody>${tableHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `);
}

// ===================== НАСТРОЙКИ =====================
function loadSettingsContent() {
    const settings = JSON.parse(localStorage.getItem('bot_settings') || '{}');
    $('#page-content').html(`
        <div class="card">
            <div class="card-header bg-white"><h5>Настройки</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Мин. вывод</label>
                        <input type="number" id="minWithdrawal" class="form-control" value="${settings.minWithdrawal||50}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Реф. бонус</label>
                        <input type="number" id="referralBonus" class="form-control" value="${settings.referralBonus||10}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Ежедневный бонус</label>
                        <input type="number" id="dailyBonus" class="form-control" value="${settings.dailyBonus||2}">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Сохранить</button>
            </div>
        </div>
    `);
}

function saveSettings() {
    const settings = {
        minWithdrawal: $('#minWithdrawal').val(),
        referralBonus: $('#referralBonus').val(),
        dailyBonus: $('#dailyBonus').val()
    };
    localStorage.setItem('bot_settings', JSON.stringify(settings));
    showNotification('success','Сохранено','Настройки обновлены');
}

// ===================== API =====================
function loadApiContent() {
    $('#page-content').html(`
        <div class="card">
            <div class="card-header bg-white"><h5>API документация</h5></div>
            <div class="card-body">
                <p>Все запросы используют X-Auth-Token</p>
                <pre>GET /users
GET /transactions
POST /message/send</pre>
            </div>
        </div>
    `);
}

// ===================== МАССОВАЯ РАССЫЛКА =====================
function showBroadcastModal() {
    $('#modalContainer').html(`
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5>Массовая рассылка</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label>Текст</label><textarea id="broadcastText" class="form-control"></textarea></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button class="btn btn-primary" onclick="sendBroadcast()">Отправить</button>
                </div>
            </div>
        </div>
    `).modal('show');
}

function sendBroadcast() {
    const text = $('#broadcastText').val();
    if (!text) return showNotification('error','Ошибка','Введите текст');
    showNotification('success','Готово','Рассылка отправлена (демо)');
    $('#modalContainer').modal('hide');
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

</body>
</html>
